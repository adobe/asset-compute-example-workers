# Copyright 2020 Adobe. All rights reserved.
# This file is licensed to you under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License. You may obtain a copy
# of the License at http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software distributed under
# the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS
# OF ANY KIND, either express or implied. See the License for the specific language
# governing permissions and limitations under the License.

language: node_js

os:
  - "windows"

node_js:
  - "10"
  - "12"
  - "14"

env:
  - TEST_DIR=projects/worker-animal-pictures
  - TEST_DIR=projects/worker-basic
  
services: 
  - docker

install:
  - npm install -g @adobe/aio-cli
  - aio plugins:install @adobe/aio-cli-plugin-asset-compute
  - aio info

script:
  - |
    (
      if [ "$TRAVIS_OS_NAME" = 'windows' ]; then
        choco install docker-desktop --pre 
        choco install docker-cli
        refreshenv
        $Env:ProgramFiles\Docker\Docker\DockerCli.exe -SwitchDaemon
        $Env:ProgramFiles\Docker\Docker\DockerCli.exe -SwitchLinuxEngine

        net stop docker
        net stop com.docker.service
        taskkill /IM "dockerd.exe" /F
        taskkill /IM "Docker for Windows.exe" /F
        net start docker
        net start com.docker.service
        start "$Env:ProgramFiles\Docker\Docker\Docker for Windows.exe"

        cd $TEST_DIR && npm install && npm test
      fi
      exit 0
    )